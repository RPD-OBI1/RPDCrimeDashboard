---
title: "`r params$sectionname` Crime Dashboard, as of `r format(Sys.Date() - 4, '%d %B, %Y')`"
output: 
  flexdashboard::flex_dashboard:
    logo: Z:/Projects/dashboard/RPDCrimeDashboard/Objects/RPDLogoSMALL.png
    orientation: column
    vertical_layout: fill
    theme: cerulean
params:
    sectionname:
        label: "Section"
        value: "Genesee"
        
---

```{r loadpackages, include=FALSE}

library(knitr)
library(flexdashboard)
library(RColorBrewer)
library(stringr)
library(ggplot2)
library(plotly)
library(KernSmooth)
library(raster)
library(leaflet)
library(dplyr)
library(reshape2)
library(jsonlite)
library(tidyr)
library(DT)
library(RODBC)
library(treemap)
library(d3treeR)
library(RColorBrewer)

source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/aoristicDayWeek.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/guntablenest.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/kerntorast.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/hotspotMap.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/hotspotMapSV.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/LERMS_incidents.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/nestedbeattable.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/plotlyhmap.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/SPC.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/pullMCUdata.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/loadshootingvictims.R")
source("Z:/Projects/dashboard/RPDCrimeDashboard/Functions/CFSloc.R")

simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), tolower(substring(s, 2)),
      sep = "", collapse = " ")
}

sectionsmatch <- data.frame(section = c(1, 3, 5, 7, 9),
                            sectionname = c("Lake", "Genesee", "Goodman", "Clinton", "Central"),
                            # lng1 = c(-77.617488, -77.604633, -77.615712, -77.575370, -77.592894),
                            # lat1 = c(43.158172, 43.114570, 43.124344, 43.159093, 43.138862),
                            # lng2 = c(-77.668684, -77.686093, -77.522970, -77.626865, -77.635598),
                            # lat2 = c(43.264020, 43.159699, 43.237813, 43.257633, 43.165201),
                            stringsAsFactors = FALSE)
section <- sectionsmatch[match(params$sectionname, sectionsmatch$sectionname),"section"]
# lng1FB <- sectionsmatch[match(params$sectionname, sectionsmatch$sectionname), "lng1"]
# lat1FB <- sectionsmatch[match(params$sectionname, sectionsmatch$sectionname), "lat1"]
# lng2FB <- sectionsmatch[match(params$sectionname, sectionsmatch$sectionname), "lng2"]
# lat2FB <- sectionsmatch[match(params$sectionname, sectionsmatch$sectionname), "lat2"]



overviewPlot <- function(control = controllimits %>% filter(Crime == "Firearm"), 
                         spcObj = firearmSPC,
                         dat = histdata %>% filter(CrimeType == "Firearm"),
                         currentyear = curr.year,
                         title = "Historical Counts for Firearm Crime"
                             ) {
    q <- dat %>% 
        plot_ly(
            x = ~Yr, 
            y = ~Counts, 
            type = "scatter", 
            mode = "lines+markers",
            line = list(color = "black"),
            name = "Historical",
            hoverinfo = "name+x+y",
            hoverlabel = list(bgcolor = "white", font = list(color = "black"))) %>% 
        add_trace(data = control,
                  x = ~Year,
                  y = ~LowerLimit,
                  type = "scatter",
                  mode = "lines",
                  line = list(color = "grey", dash = "dash"),
                  name = "Lower Limit",
                  hoverinfo = "name+y",
                  hoverlabel = list(bgcolor = "white", font = list(color = "black"))) %>%
        add_trace(data = control,
                  x = ~Year,
                  y = ~UpperLimit,
                  type = "scatter",
                  mode = "lines",
                  line = list(color = "grey", dash = "dash"),
                  name = "Upper Limit",
                  hoverinfo = "name+y",
                  hoverlabel = list(bgcolor = "white", font = list(color = "black"))) %>%
        add_trace(data = spcObj[[5]] %>% group_by(Value) %>% count(),
                  x = curr.year,
                  y = ~Value,
                  type = "scatter",
                  mode = "markers",
                  marker = list(color = "grey"),
                  size = ~n,
                  opacity = .3,
                  name = "Sims",
                  hovertext = ~paste0(n, " of 1000 sims result in ", Value, " at year end."),
                  hoverinfo = "text",
                  hoverlabel = list(bgcolor = "white", font = list(color = "black"))) %>%
        add_trace(x = currentyear,
                  y = mean(spcObj[[5]]$Value),
                  type = "scatter",
                  mode = "markers",
                  name = "Avg sim",
                  hoverinfo = "name",
                  marker = list(size = 10, color = "blue")) %>%
        layout(showlegend = FALSE,
               xaxis = list(title = ""),
               yaxis = list(title = ""),
               title = title)
    return(q)
    
}


```

```{r setup}

# Read in previously-created list of maps; keep only the relevant section one
sectionmap <- readRDS("Z:/Projects/dashboard/RPDCrimeDashboard/Objects/sectionmaplist.RDS")[params$sectionname][[1]]

curr.year <- as.numeric(format(Sys.Date(), '%Y')) ### This current year to automatically reference the current year
begindate <- paste0(curr.year, '-01-01') ### For CFS to automatically create the begindate based on current year

#sevenDayGroupTable is a lookup table to get the current week (Group) from the date
#Because it uses length(Date) from seq.Date, it should work even in leap years

sevenDayGroupTable <- data.frame(Date = seq.Date(from = as.Date(begindate),
                                                 to = as.Date(paste0(curr.year, "-12-31")),
                                                 by = 1)) %>%
    mutate(DOY = 1:length(Date),
           Group = c(rep(1:51, each = 7), 
                     rep(52, times = length(Date) - 357)))

curr.week <- sevenDayGroupTable$Group[match(as.numeric(format(Sys.Date(), 
                                                             '%j')), 
                                           sevenDayGroupTable$DOY)] - 1

firearm.desc <- trimws(c('Prohibited Use of Weapon City Limits', 
                        'Use of Dangerous Weapon', 
                        'Criminal Use Firearm 1st: Commit Violent Class B Felony', 
                        'Discharges Loaded Firearm', 
                        'Use Firearm 1st: Possess a Deadly Weapon-Loaded',
                        'Criminal Use Firearm 2nd: Possess Deadly Weapon: Loaded', 
                        'Use Firearm 1st: Display Firearm', 
                        'Criminal Use Firearm 2nd: Display Firearm'))

firearmCrimeTypes <- c("Aggravated Assault", "Robbery", "Homicide", "Rape", "Simple Assault")

#load in RPD's crime data

df <- readRDS("Z:/Projects/dashboard/RPDCrimeDashboard/Objects/sectiondflist.RDS")[params$sectionname][[1]]

#use beatNames to make factor levels for beats
beatNames <- df %>%
    dplyr::select(GEOBeat) %>%
    unique() %>% 
    filter(! grepl(x = GEOBeat, pattern = "\\*")) %>% #remove *** as a beat name
    arrange(substr(GEOBeat, 3, 3), GEOBeat) %>%
    mutate(GEOBeat = as.factor(GEOBeat)) #this keeps *** as a factor level

CPWs <- df %>% filter(CrimeType == "Dangerous Weapons" & 
                          !trimws(Description) %in% firearm.desc &
                          as.numeric(WeaponIBRValue) < 11) %>%
    mutate(OccurFromDate = as.character(OccurFromDate)) #for table display purposes

crimes <- c('Aggravated Assault', 'Arson', 'Burglary', 'Homicide', 'Larceny', 'MV Theft', 'Rape', 'Robbery', 'Firearm')
sec <- c('Lake', 'Genesee', 'Goodman', 'Clinton', 'Central')

pal <- brewer.pal(name = "Reds", n = 9)

PropVals <- read.csv("Z:/Projects/dashboard/RPDCrimeDashboard/Objects/ProportionsAndCounts.csv", 
                     header= T) %>%
    filter(Section == params$sectionname)
ShootingControlLimits <- readr::read_csv("Z:/Projects/dashboard/RPDCrimeDashboard/Objects/3YrWeightedControlLimitsShootings.csv") %>%
    filter(Section == params$sectionname)
ShootingProps <- readr::read_csv("Z:/Projects/dashboard/RPDCrimeDashboard/Objects/ProportionsAndCountsShootings.csv") %>%
    dplyr::filter(Section == params$sectionname)

histdata <- readr::read_csv(file = "Z:/Projects/dashboard/RPDCrimeDashboard/Objects/historicaldata.csv") %>%
    dplyr::filter(Section == section)

controllimits <- readr::read_csv(file = "Z:/Projects/dashboard/RPDCrimeDashboard/Objects//3YrWeightedControlLimits.csv") %>%
    dplyr::filter(Section == params$sectionname)

controllimits <- rbind(data.frame(controllimits, Year = 2017),
                       data.frame(controllimits, Year = 2018),
                       data.frame(controllimits, Year = 2019))

mculist <- pullMCUdata()
MCUhoms <- mculist[[1]] %>%
    filter(Section == params$sectionname) %>%
    mutate(CrimeType = "Homicide",
           DateOfEvent = as.Date(DateOfEvent, format = "%Y-%m-%d"),
           DOYofEvent = as.numeric(format(DateOfEvent, "%j")),
           YearofEvent = as.numeric(format(DateOfEvent, "%Y")),
           CaseStatus = unname(sapply(CaseStatus, simpleCap))) %>%
    filter(YearofEvent == curr.year) %>%
    rename(sec = Section, 
           Lat = Latitude, 
           Lon = Longitude, 
           FullAddress = Address) %>%
    left_join(sevenDayGroupTable, by = c("DOYofEvent" = "DOY")) %>%
    dplyr::select(-Date) %>%
    dplyr::rename("SevenDaysGroup" = Group)



person <- mculist[[2]]
rm(mculist)

personincident <- left_join(MCUhoms, person, by = "CaseNumber")

sv <- loadshootingvictims()
drops <- c("Lat", "Lon")
svjoined <- left_join(x = sv, y = df, by = c("CaseNumber" = "CRNum")) %>%
    dplyr::select(-one_of(drops)) %>%
    rename(Lat = Latitude, Lon = Longitude) %>%
    filter(sec == params$sectionname)
rm(sv)

loc <- CFSloc()
#Exclude is for later use, excluding from hotspots/mapping/etc
exclude <- c("630 North Clinton Ave, Rochester, NY, 14605", 
             "185 Exchange Blvd, Rochester, NY, 14614",
             "1099 Jay St, Rochester, NY, 14611")

sectionSPC <- readRDS("Z:/Projects/dashboard/RPDCrimeDashboard/Objects/sectionSPClist.RDS")[params$sectionname][[1]]
firearmSPC <- sectionSPC$Firearm
svSPC <- sectionSPC$SV
homicideSPC <- sectionSPC$Homicide
rapeSPC <- sectionSPC$Rape
robSPC <- sectionSPC$Rob
asltSPC <- sectionSPC$Aslt
burgSPC <- sectionSPC$Burg
larcSPC <- sectionSPC$Larc

odbcCloseAll()

```



Overview {data-navmenu="Home"}
======================================================================

Column{data-width=500}
------------------------------------------------------------------------------

### Breakdown of crimes & action limits

```{r}
#Check to make sure this year's firearm homicides are in the firearm data
if(nrow(MCUhoms) > 0){
    MCUhoms$CaseNumber <- paste0("20", 
                                 substr(MCUhoms$CaseNumber, 1, 3),
                                 "00", 
                                 substr(MCUhoms$CaseNumber, 4, 9))
    }

firearmhoms <- MCUhoms %>% 
    filter(YearofEvent == curr.year, WeaponType == "Firearm")
# if(any(! firearmhoms$CaseNumber %in% filter(df, Firearm == "Firearm"))){
#     cat("There are firearm homicides that do not appear in the firearm data due to LERMS issues.")
# }

tab <- data.frame(CrimeTypes = c("Firearm crime", "Shootings", "Robbery", 
                                 "Aggravated Assault", "Burglary", "Larceny"),
                  Counts = c(firearmSPC[[4]], svSPC[[4]], robSPC[[4]], 
                             asltSPC[[4]], burgSPC[[4]], larcSPC[[4]]),
                  RiskOfRed = c(firearmSPC[[2]], svSPC[[2]], robSPC[[2]], 
                                asltSPC[[2]], burgSPC[[2]], larcSPC[[2]]),
                  ChanceOfGreen = c(firearmSPC[[3]], svSPC[[3]], robSPC[[3]], 
                                    asltSPC[[3]], burgSPC[[3]], larcSPC[[3]]))
#knitr::kable(tab, col.names = c("Crime Types", 
#                                "YTD Totals", 
#                                "% chance of exceeding upper action limit", 
#                                "% chance of beating lower action limit"))
DT::datatable(tab,
              rownames = FALSE,
              colnames = c("Crime Types", 
                           "YTD Totals", 
                           "% chance of exceeding upper action limit", 
                           "% chance of beating lower action limit"),
              options = list(dom = 'tf',
                             columnDefs = list(list(className = 'dt-right', targets = 0:3))))
```

### Closure rates

```{r}
CrimeTypes <- c("Aggravated Assault", "Burglary", "Homicide", "Larceny",
                 "MV Theft", "Rape", "Robbery", "Dangerous Weapons")

treedata <- df %>%
    filter(CrimeType %in% CrimeTypes) %>%
    filter(SevenDaysGroup %in% 1:curr.week) %>%
    count(CrimeType = CrimeType,
          Clearance = ClearanceStatusValue, 
          Closure = CaseStatusValue) %>%
    ungroup() %>%
    group_by(CrimeType) %>%
    mutate(CrimeTypeCount = sum(n)) %>%
    group_by(CrimeType, Closure) %>%
    mutate(ClosureCount = sum(n)) %>%
    ungroup() %>%
    mutate(CrimeType = paste0(CrimeType, " (", 
                              CrimeTypeCount, ", ",
                              round(100 * CrimeTypeCount / sum(n), 2), 
                              "%)  "),
           Closure = paste0(Closure, " (",
                            ClosureCount, ", ",
                            round(100 * ClosureCount / CrimeTypeCount, 2),
                            "%)  "),
           Clearance = paste0(Clearance, " (",
                              n, ", ",
                              round(100 * n / ClosureCount, 2),
                              "%)"))

pdf(NULL)
clearanceTreeMap <- d3tree2(
    treemap(
        treedata,
        index = c("CrimeType", "Closure", "Clearance"),
        vSize = "n",
        draw = FALSE),
        rootname = "Total"
    )

clearanceTreeMap
```

Column {data-width=500 .tabset .tabset-fade}
------------------------------------------------------------------------------

### Firearm Crime

```{r}
firearmcontrol <- filter(controllimits, Crime == "Firearm")
SimsAvg <- mean(firearmSPC[[5]]$Value)

overviewPlot(control = controllimits %>% filter(Crime == "Firearm"),
             spcObj = firearmSPC,
             dat = histdata %>% filter(CrimeType == "Firearm"),
             currentyear = curr.year,
             title = "Historical Counts for Firearm Crime")

```

### Shooting Victims

```{r shootingsmainpage}

overviewPlot(control = ShootingControlLimits,
             spcObj = svSPC,
             dat = histdata %>% filter(CrimeType == "Shooting"),
             currentyear = curr.year,
             title = "Historical Counts for Shootings")

```

### Robbery

```{r}

overviewPlot(control = controllimits %>% filter(Crime == "Robbery"),
             spcObj = robSPC,
             dat = histdata %>% filter(CrimeType == "Robbery"),
             currentyear = curr.year,
             title = "Historical Counts for Robbery")


```

### Aggravated Assault

```{r}

overviewPlot(control = controllimits %>% filter(Crime == "Aggravated Assault"),
             spcObj = asltSPC,
             dat = histdata %>% filter(CrimeType == "Aggravated Assault"),
             currentyear = curr.year,
             title = "Historical Counts for Agg Assault")

```

### Burglary

```{r}

overviewPlot(control = controllimits %>% filter(Crime == "Burglary"),
             spcObj = burgSPC,
             dat = histdata %>% filter(CrimeType == "Burglary"),
             currentyear = curr.year,
             title = "Historical Counts for Burglary")

```

### Larceny

```{r}

overviewPlot(control = controllimits %>% filter(Crime == "Larceny"),
             spcObj = larcSPC,
             dat = histdata %>% filter(CrimeType == "Larceny"),
             currentyear = curr.year,
             title = "Historical Counts for Larceny")
```

### Homicide

```{r}

overviewPlot(control = controllimits %>% filter(Crime == "Homicide"),
             spcObj = homicideSPC,
             dat = histdata %>% filter(CrimeType == "Homicide"),
             currentyear = curr.year,
             title = "Historical Counts for Homicide")
```

### Rape

```{r}

overviewPlot(control = controllimits %>% filter(Crime == "Rape"),
             spcObj = rapeSPC,
             dat = histdata %>% filter(CrimeType == "Rape"),
             currentyear = curr.year,
             title = "Historical Counts for Rape")
```

Firearm Crime {data-navmenu="Violent Crime"}
======================================================================

Column {data-width=400}
------------------------------------------------------------------------------

```{r fig.align='center', fig.height = 1}

par(mar=c(0,0,0,0))
plot(c(0, 1000), c(0, 20), type = 'n', xlab = '', ylab = '', xaxt = 'n', yaxt ='n', bty = 'n')
rect(0, 0, 1000, 20, col = 'white', border = 'darkgrey', lwd = 1)
text(x = 500, y = 10, labels = "Firearm Crime", cex = 2, col = 'black')

```

### Projection

```{r}

firearmSPC[[1]]

```

### Aoristic heatmap

```{r}
df$WeaponIBRValue <- as.numeric(df$WeaponIBRValue)
mat <- aoristicDayWeek(filter(df, WeaponIBRValue < 11))
plotlyhmap(mat)

```

Column {data-width=400 .tabset .tabset-fade}
------------------------------------------------------------------------------

### YTD Hotspot map

```{r whydoesthisfail}

guns <- dplyr::filter(df, Firearm == "Firearm")
map <- hotspotMap(sectionmap, 
                  dplyr::filter(guns, Lat != -361))
map

```

### 28 day Hotspot map

```{r}

guns28 <- guns %>%
    filter(Lat != -361 & SevenDaysGroup > curr.week - 4)
if(nrow(guns28) > 0){
    map <- hotspotMap(sectionmap, guns28)
    map
}

```

Column{data-width=300 .tabset .tabset-fade}
-------------------------------------------------------------------------------

### Beats

There were `r nrow(guns)` overall firearm-involved crimes (including simulated and imitation firearms).

```{r}
dat <- df %>%
    filter(Firearm == "Firearm")

x <- nestedbeattable(dat)
x <- x[substr(x$Beat, 3, 3) == section, c("Beat", "count")] #filtering out non-relevant rows

DT::datatable(x %>% mutate(Beat = factor(Beat)),
              rownames = FALSE,
              colnames = c('Beat', 'Count'),
              options = list(dom = 'tf', 
                             pageLength = 100, 
                             columnDefs = list(list(className = 'dt-right', targets = 0:1))))
```

### Crime Types

There were `r nrow(guns)` overall firearm-involved crimes (including simulated and immitation firearms).

```{r}

DT::datatable(guntablenest(df), 
              rownames = FALSE,
              colnames = c("Crime Type", "Description", "Counts"), 
              options = list(pageLength = 100, 
                             dom = 'tf',
                             ordering = FALSE,
                             columnDefs = list(list(className = 'dt-right', targets = 0:2))))
```

### CPWs

There were `r nrow(CPWs)` CPW crimes (excluding knives/brass knuckle crimes). These CPWs are not counted in the overall firearm-related statistics.

```{r}

DT::datatable(CPWs[, c("FullAddress", "Beat", "OccurFromDate", "Description")],
              filter = 'top',
              rownames = FALSE,
              colnames = c('Address', 'Beat', 'Date', 'Description'),
              options = list(pageLength = 100, 
                             dom = 'tf',
                             columnDefs = list(list(className = 'dt-right', targets = 0:3))))
```

Shooting Victims {data-navmenu="Violent Crime"}
======================================================================

Column {data-width=400}
----------------------------------------------------------------------

```{r fig.align='center', fig.height = 1}

par(mar=c(0,0,0,0))
plot(c(0, 1000), c(0, 20), type = 'n', xlab = '', ylab = '', xaxt = 'n', yaxt ='n', bty = 'n')
rect(0, 0, 1000, 20, col = 'white', border = 'darkgrey', lwd = 1)
text(x = 500, y = 10, labels = "Shooting Victims", cex = 2, col = 'black')

```

### Projection

```{r}
svSPC[[1]]

```

### Aoristic Heatmap

```{r}
if(nrow(svjoined) > 0){
    mat <- aoristicDayWeek(svjoined)
    plotlyhmap(mat)
}


```

Column {data-width=400 .tabset .tabset-fade}
----------------------------------------------------------------------

### YTD Hotspot map

```{r}
if(nrow(svjoined) > 0){
    dohotspot <- ifelse(nrow(svjoined) > 10, yes = TRUE, no = FALSE)
    map <- hotspotMapSV(basemap = sectionmap, 
                        mapdf = svjoined, 
                        doHotSpot = dohotspot)
    map
}

```

### 28 day Hotspot map

```{r}

svjoin28 <- dplyr::filter(svjoined,
                   SevenDaysGroup >= curr.week - 3)

if(nrow(svjoin28) > 0){
    dohotspot <- ifelse(nrow(svjoin28) > 10, yes = TRUE, no = FALSE)
    
    map <- hotspotMapSV(basemap = sectionmap, 
                        mapdf = svjoin28, 
                        doHotSpot = dohotspot)
    map
}
```

Column {data-width=300 .tabset .tabset-fade}
----------------------------------------------------------------------

### Beats

There have been `r nrow(svjoined)` shooting victims thus far.

```{r}
if(nrow(svjoined) > 0){
    x <- nestedbeattable(svjoined)
    x <- x[substr(x$Beat, 3, 3) == section, c("Beat", "count")] 
    #filtering out non-relevant rows
    DT::datatable(x %>% mutate(Beat = factor(Beat)),
                  rownames = FALSE,
                  colnames = c("Beat", "Count"),
                  options = list(pageLength = 100, 
                                dom = 'tf', 
                                columnDefs = list(list(className = 'dt-right', targets = 0:1)))
                  )
}

```

### Multiples & Homicides

There were `r nrow(svjoined)` total shooting victims in `r length(unique(svjoined$CaseNumber))` incidents.

`r nrow(filter(svjoined, CrimeType.x == "Homicide"))` of these victims are victims of homicide.

```{r}

if(nrow(svjoined) > 0){
    temptab <- svjoined %>% count(CaseNumber)
    temptab$n <- factor(temptab$n, levels = 1:max(temptab$n))
    temptab$n %>% 
        table() %>%
        as.data.frame() %>%
        arrange(.) %>%
        
    DT::datatable(filter = 'top',
                  rownames = FALSE, 
                  colnames = c("Victims per Incident", "Count"),
                  options = list(pageLength = 100, 
                                 dom = 'tf', 
                                 ordering = FALSE,
                                 columnDefs = list(list(className = 'dt-right', targets = 0:1))))

}

```

Robbery {data-navmenu="Violent Crime"}
======================================================================

Column {data-width=400}
-----------------------------------------------------------------------

```{r fig.align='center', fig.height = 1}

par(mar=c(0,0,0,0))
plot(c(0, 1000), c(0, 20), type = 'n', xlab = '', ylab = '', xaxt = 'n', yaxt ='n', bty = 'n')
rect(0, 0, 1000, 20, col = 'white', border = 'darkgrey', lwd = 1)
text(x = 500, y = 10, labels = "Robbery", cex = 2, col = 'black')

```

### Projection

```{r}

robSPC[[1]]

```

### Aoristic Heatmap

```{r}
robs <- filter(df, CrimeType == "Robbery")
mat <- aoristicDayWeek(robs)
plotlyhmap(mat)
```


Column {data-width=400 .tabset .tabset-fade}
-----------------------------------------------------------------------

### YTD Hotspot map

```{r}

robsgeo <- filter(df, Lat != -361 & CrimeType == "Robbery")
map <- hotspotMap(basemap = sectionmap, 
                  mapdf = robsgeo)
map

```

### 28 day Hotspot map

```{r}

robsgeo <- filter(df, Lat != -361 & 
                      CrimeType == "Robbery" & 
                      SevenDaysGroup >= curr.week - 3)
if(nrow(robsgeo) > 0){
    map <- hotspotMap(basemap = sectionmap, 
                  mapdf = robsgeo)
    map
}


```

Column {data-width=300 .tabset .tabset-fade}
------------------------------------------------------------------------

### Beats

There have been `r df %>% dplyr::filter(CrimeType == "Robbery") %>% nrow()` total robberies thus far.

```{r}
dat <- df %>%
    dplyr::filter(CrimeType == "Robbery")

x <- nestedbeattable(dat)
x <- x[substr(x$Beat, 3, 3) == section, c("Beat", "count")] #filtering out non-relevant rows
DT::datatable(x %>% mutate(Beat = factor(Beat)),
              filter = 'top',
              rownames = FALSE,
              colnames = c("Beat", "Count"),
              options = list(pageLength = 100, 
                             dom = 'tf', 
                             columnDefs = list(list(className = 'dt-right', targets = 0:1))))
```

### Weapon Types

There have been `r df %>% dplyr::filter(CrimeType == "Robbery") %>% nrow()` total robberies thus far.

```{r}

robs %>%
    group_by(WeaponGroup) %>%
    count() %>%
    arrange(desc(n)) %>%
    ungroup() %>% 
    mutate(WeaponGroup = factor(WeaponGroup)) %>%
    DT::datatable(filter = 'top',
                  rownames = FALSE,
                  colnames = c("Weapon", "Count"),
                  options = list(pageLength = 100,
                                 dom = 'tf',
                                 columnDefs = list(list(className = 'dt-right', targets = 0:1))))

```

### Locations

There have been `r df %>% dplyr::filter(CrimeType == "Robbery") %>% nrow()` total robberies thus far.

```{r}

robs %>% 
    group_by(LocationSceneDescription) %>%
    count() %>%
    arrange(desc(n)) %>%
    ungroup() %>%
    mutate(LocationSceneDescription = factor(LocationSceneDescription)) %>%
    DT::datatable(filter = 'top',
                  rownames = FALSE,
                  colnames = c("Location", "Count"),
                  options = list(pageLength = 100, 
                                 dom = 'tf',
                                 columnDefs = list(list(className = 'dt-right', targets = 0:1))))
```

Aggravated Assault {data-navmenu="Violent Crime"}
======================================================================

Column {data-width=400}
-----------------------------------------------------------------------

```{r fig.align='center', fig.height = 1}

par(mar=c(0,0,0,0))
plot(c(0, 1000), c(0, 20), type = 'n', xlab = '', ylab = '', xaxt = 'n', yaxt ='n', bty = 'n')
rect(0, 0, 1000, 20, col = 'white', border = 'darkgrey', lwd = 1)
text(x = 500, y = 10, labels = "Aggravated Assault", cex = 2, col = 'black')

```

### Projection


```{r}

asltSPC[[1]]

```

### Aoristic heatmap

```{r}
aslts <- filter(df, CrimeType == "Aggravated Assault")
mat <- aoristicDayWeek(aslts)
plotlyhmap(mat)
```


Column {data-width=400 .tabset .tabset-fade}
-----------------------------------------------------------------------

### YTD Hotspot map

```{r}

asltsgeo <- filter(df, Lat != -361 & CrimeType == "Aggravated Assault")
map <- hotspotMap(basemap = sectionmap, 
                  mapdf = asltsgeo)
map

```

### 28 day Hotspot map

```{r}
map <- hotspotMap(basemap = sectionmap, 
                  mapdf = filter(asltsgeo, 
                                 SevenDaysGroup >= curr.week - 3))
map
```

Column {data-width=300 .tabset .tabset-fade}
------------------------------------------------------------------------

### Beats

There have been `r df %>% dplyr::filter(CrimeType == "Aggravated Assault") %>% nrow()` total aggravated assaults thus far.

```{r}
dat <- df %>%
    dplyr::filter(CrimeType == "Aggravated Assault")

x <- nestedbeattable(dat)
x <- x[substr(x$Beat, 3, 3) == section, c("Beat", "count")] #filtering out non-relevant rows
DT::datatable(x %>% mutate(Beat = factor(Beat)),
              filter = 'top',
              rownames = FALSE,
              colnames = c("Beat", "Count"),
              options = list(pageLength = 100, 
                             dom = 'tf', 
                             columnDefs = list(list(className = 'dt-right', targets = 0:1))))
```

### Weapon Types

There have been `r df %>% dplyr::filter(CrimeType == "Aggravated Assault") %>% nrow()` total aggravated assaults thus far.

```{r}

table(aslts$WeaponGroup) %>%
    as.data.frame() %>%
    DT::datatable(filter = 'top',
                  rownames = FALSE,
                  colnames = c("Weapon", "Count"),
                  options = list(pageLength = 100, 
                                 dom = 'tf',
                                 columnDefs = list(list(className = 'dt-right', targets = 0:1))))

```

### Locations

There have been `r df %>% dplyr::filter(CrimeType == "Aggravated Assault") %>% nrow()` total aggravated assaults thus far.

```{r}

aslts %>% 
    dplyr::select(LocationSceneDescription) %>%
    table() %>%
    as.data.frame() %>%
    arrange(desc(Freq)) %>%
    #kable(row.names = FALSE, col.names = c("Location", "Count"))
    DT::datatable(filter = 'top',
                  rownames = FALSE,
                  colnames = c("Location", "Count"),
                  options = list(pageLength = 100, 
                                 dom = 'tf',
                                 columnDefs = list(list(className = 'dt-right', targets = 0:1))))

```


Burglary {data-navmenu="Property Crime"}
======================================================================

Column {data-width=400}
-----------------------------------------------------------------------

```{r fig.align='center', fig.height = 1}

par(mar=c(0,0,0,0))
plot(c(0, 1000), c(0, 20), type = 'n', xlab = '', ylab = '', xaxt = 'n', yaxt ='n', bty = 'n')
rect(0, 0, 1000, 20, col = 'white', border = 'darkgrey', lwd = 1)
text(x = 500, y = 10, labels = "Burglary", cex = 2, col = 'black')

```

### Projection

```{r}

burgSPC[[1]]

```

### Aoristic heatmap

```{r}
burgs <- filter(df, CrimeType == "Burglary")
mat <- aoristicDayWeek(burgs)
plotlyhmap(mat)
```

Column {data-width=400 .tabset .tabset-fade}
-----------------------------------------------------------------------

### YTD Hotspot map

```{r}

burgsgeo <- filter(df, Lat != -361 & CrimeType == "Burglary")
map <- hotspotMap(basemap = sectionmap, 
                  mapdf = burgsgeo)
map

```

### 28 day Hotspot map

```{r}
map <- hotspotMap(basemap = sectionmap, 
                  mapdf = filter(burgsgeo, 
                                 SevenDaysGroup >= curr.week - 3))
map
```

Column {data-width=300 .tabset .tabset-fade}
-----------------------------------------------------------------------

### Beats

There have been `r df %>% dplyr::filter(CrimeType == "Burglary") %>% nrow()` total burglaries thus far.

```{r}
dat <- df %>%
    dplyr::filter(CrimeType == "Burglary")

x <- nestedbeattable(dat)
x <- x[substr(x$Beat, 3, 3) == section, c("Beat", "count")] #filtering out non-relevant rows
DT::datatable(x %>% mutate(Beat = factor(Beat)),
              filter ='top',
              rownames = FALSE,
              colnames = c("Beat", "Count"),
              options = list(pageLength = 100, 
                             dom = 'tf', 
                             columnDefs = list(list(className = 'dt-right', targets = 0:1))))
```

### Locations

There have been `r df %>% dplyr::filter(CrimeType == "Burglary") %>% nrow()` total burglaries thus far.

```{r}
tab <- as.data.frame(table(burgs$LocationScene), stringsAsFactors = TRUE)
tab <- tab[order(tab$Freq, decreasing = TRUE),]

DT::datatable(tab, filter = 'top',
                   rownames = FALSE,
                   colnames = c("Location", "Count"),
                   options = list(pageLength = 100, 
                                  dom = 'tf',
                                  columnDefs = list(list(className = 'dt-right', targets = 0:1))))
```


Larceny {data-navmenu="Property Crime"}
======================================================================

Column {data-width=400}
-----------------------------------------------------------------------

```{r fig.align='center', fig.height = 1}

par(mar=c(0,0,0,0))
plot(c(0, 1000), c(0, 20), type = 'n', xlab = '', ylab = '', xaxt = 'n', yaxt ='n', bty = 'n')
rect(0, 0, 1000, 20, col = 'white', border = 'darkgrey', lwd = 1)
text(x = 500, y = 10, labels = "Larceny", cex = 2, col = 'black')

```

### Projection

```{r}

larcSPC[[1]]

```

### Aoristic heatmap

```{r}
larcs <- filter(df, CrimeType == "Larceny")
mat <- aoristicDayWeek(larcs)
plotlyhmap(mat)
```

Column {data-width=400 .tabset .tabset-fade}
-----------------------------------------------------------------------

### YTD map

```{r}

larcsgeo <- filter(df, Lat != -361 & CrimeType == "Larceny")
map <- hotspotMap(basemap = sectionmap, 
                  mapdf = larcsgeo)
map

```

### 28 day map

```{r}
map <- hotspotMap(basemap = sectionmap, 
                  mapdf = filter(larcsgeo, 
                                 SevenDaysGroup >= curr.week - 3))
map

```

### YTD map - Theft from MV

```{r}

carbreakins <- filter(df, Lat != -361 & 
                       CrimeType == "Larceny" & 
                       LarcenyTypeDescription == "Theft from Motor Vehicle")
map <- hotspotMap(basemap = sectionmap, 
                  mapdf = carbreakins)
map

```

### 28 day map - Theft from MV

```{r}
map <- carbreakins %>%
    filter(SevenDaysGroup >= curr.week - 3) %>%
    hotspotMap(basemap = sectionmap)

map
```

Column {data-width=300 .tabset .tabset-fade}
-----------------------------------------------------------------------

### Beats

There have been `r df %>% dplyr::filter(CrimeType == "Larceny") %>% nrow()` total larcenies thus far.

```{r}
dat <- df %>%
    dplyr::filter(CrimeType == "Larceny")

x <- nestedbeattable(dat)
x <- x[substr(x$Beat, 3, 3) == section, c("Beat", "count")] #filtering out non-relevant rows
DT::datatable(x %>% mutate(Beat = factor(Beat)),
              filter = 'top',
              rownames = FALSE,
              colnames = c("Beat", "Count"),
              options = list(pageLength = 100, 
                             dom = 'tf', 
                             columnDefs = list(list(className = 'dt-right', targets = 0:1))))
```

### Larceny Types

There have been `r df %>% dplyr::filter(CrimeType == "Larceny") %>% nrow()` total larcenies thus far.

```{r}
larcs %>%
    group_by(LarcenyTypeDescription) %>%
    count() %>%
    ungroup() %>%
    mutate(LarcenyTypeDescription = factor(LarcenyTypeDescription)) %>%
    arrange(desc(n)) %>%
    DT::datatable(
              filter = 'top',
              rownames = FALSE,
              colnames = c("Larceny Type", "Count"),
              options = list(pageLength = 100, 
                             dom = 'tf',
                             columnDefs = list(list(className = 'dt-right', targets = 0:1))))

```

Homicide {data-navmenu="Violent Crime"}
======================================================================

Column {data-width=600 .tabset .tabset-fade}
-----------------------------------------------------------------------

```{r fig.align='center', fig.height = 1}

par(mar=c(0,0,0,0))
plot(c(0, 1000), c(0, 20), type = 'n', xlab = '', ylab = '', xaxt = 'n', yaxt ='n', bty = 'n')
rect(0, 0, 1000, 20, col = 'white', border = 'darkgrey', lwd = 1)
text(x = 500, y = 10, labels = "Homicide", cex = 2, col = 'black')

```

### Victims & Arrestees

```{r}
if(nrow(personincident) > 0){
    persons <- personincident %>% 
        filter(PersonType %in% c("Victim", "Arrestee")) %>%
        dplyr::select(CaseNumber, Beat, DateOfEvent, DateOfDeath, 
               CaseStatus, WeaponType, PersonType, Name, DOB) %>%
        mutate(PersonType = factor(PersonType),
               Beat = factor(Beat),
               WeaponType = factor(WeaponType),
               CaseStatus = factor(CaseStatus)) %>%
        arrange(DateOfEvent)
    
    DT::datatable(persons,
                  filter = 'top',
                  rownames = FALSE,
                  colnames = c('Case Number', 'Beat', 'Event Date', 'Date of Death', ' Case Status', 
                               'Weapon Type', 'Person Type', 'Name', 'DOB'),
                  options = list(pageLength = 100,
                                 dom = 'tf',
                                 columnDefs = list(list(className = 'dt-right', targets = 0:8))))
    }


```


### Weapon Types

```{r}
if(nrow(MCUhoms) > 0){
    
    DT::datatable(as.data.frame(table(MCUhoms$WeaponType)),
                  filter = 'top',
                  rownames = FALSE,
                  colnames = c('Weapon', 'Count'),
                  options = list(pageLength = 100,
                                 dom = 'tf',
                                 columnDefs = list(list(className = 'dt-right', targets = 0:1))))
}

```

### Case status

```{r}
if(nrow(MCUhoms) > 0){
    
    DT::datatable(as.data.frame(table(MCUhoms$Disposition[MCUhoms$YearofEvent == curr.year], 
                                 MCUhoms$CaseStatus[MCUhoms$YearofEvent == curr.year])),
                  filter = 'top',
                  rownames = FALSE,
                  colnames = c('Disposition', 'Case Status', 'Count'),
                  options = list(pageLength = 100,
                                 dom = 'tf',
                                 columnDefs = list(list(className = 'dt-right', targets = 0:2))))
}
```

Column {data-width=300 .tabset .tabset-fade}
-----------------------------------------------------------------------

### YTD Hotspot map

```{r}
homs <- data.frame(FullAddress = MCUhoms$FullAddress,
                   OccurToDate = MCUhoms$DateOfEvent,
                   CaseNumber = MCUhoms$CaseNumber,
                   Lat = MCUhoms$Lat,
                   Lon = MCUhoms$Lon,
                   SevenDaysGroup = MCUhoms$SevenDaysGroup,
                   stringsAsFactors = FALSE)



if(nrow(homs) == 0) {
    cat("No homicides this year")
} else{
    
    map <- hotspotMap(basemap = sectionmap, 
                      mapdf = homs,
                      doHotSpot = FALSE)
    map
}

```

### 28 day Hotspot map

```{r}
if(nrow(filter(MCUhoms, SevenDaysGroup > curr.week - 4)) == 0) {
    cat("No homicides past 28 days citywide")
} else{
    homs28 <- filter(homs, SevenDaysGroup >= curr.week - 3)
    map <- hotspotMap(basemap = sectionmap, 
                      mapdf = homs28, 
                      doHotSpot = FALSE)
    map
}

```

Rape {data-navmenu="Violent Crime"}
======================================================================

Column {data-width=600 .tabset .tabset-fade}
-----------------------------------------------------------------------

```{r fig.align='center', fig.height = 1}

par(mar=c(0,0,0,0))
plot(c(0, 1000), c(0, 20), type = 'n', xlab = '', ylab = '', xaxt = 'n', yaxt ='n', bty = 'n')
rect(0, 0, 1000, 20, col = 'white', border = 'darkgrey', lwd = 1)
text(x = 500, y = 10, labels = "Rape", cex = 2, col = 'black')

```

### Table overview

```{r}
rapes <- df %>%
    filter(CrimeType == "Rape")

rapes %>%
    dplyr::select(CaseNumber, FullAddress, OccurToDate, 
           ReportDate, LocationSceneDescription, CaseStatusValue) %>%
    mutate(LocationSceneDescription = factor(LocationSceneDescription),
           CaseStatusValue = factor(CaseStatusValue)) %>%
    arrange(ReportDate) %>%
    mutate(OccurToDate = as.Date(OccurToDate, format = "%Y-%m-%d")) %>%
    DT::datatable(filter = 'top',
                  rownames = FALSE,
                  colnames = c('Case Number', 'Address', 'Event Date', 'Report Date', 'Location', 'Clearance'),
                  options = list(pageLength = 100,
                                 dom = 'tf',
                                 columnDefs = list(list(className = 'dt-right', targets = 0:4))))

```

### Victim/Offender relationship

```{r}

cat("Victim/Offender relationship data has not yet been made available by IT.")

```

### Location/Scene

```{r}

rapes %>% 
    dplyr::select(LocationSceneDescription) %>%
    table() %>% 
    as.data.frame() %>% 
    arrange(desc(Freq)) %>%
    DT::datatable(filter = 'top',
                  rownames = FALSE,
                  colnames = c("Location", "Count"),
                  options = list(pageLength = 100, 
                                 dom = 'tf',
                                 columnDefs = list(list(className = 'dt-right', targets = 0:1))))

```

### Charges

```{r}
rapes %>%
    group_by(Description) %>%
    count() %>%
    arrange(desc(n)) %>%
    ungroup() %>%
    mutate(Description = factor(Description)) %>%
    DT::datatable(filter = 'top',
                  rownames = FALSE,
                  colnames = c("Charge Description", "Count"),
                  options = list(pageLength = 100, 
                                 dom = 'tf',
                                 ordering = FALSE,
                                 columnDefs = list(list(className = 'dt-right', targets = 0:1))))  
 
```

### UCR Types

```{r}
rapes %>% 
    group_by(UCRText) %>%
    count() %>%
    ungroup() %>%
    mutate(UCRText = factor(UCRText)) %>%
    DT::datatable(filter = 'top',
                  rownames = FALSE,
                  colnames = c("Rape UCR Type", "Count"),
                  options = list(pageLength = 100, 
                                 dom = 'tf',
                                 ordering = FALSE,
                                 columnDefs = list(list(className = 'dt-right', targets = 0:1))))

```

Column {data-width=300 .tabset .tabset-fade}
-----------------------------------------------------------------------

### YTD Hotspot map

```{r}

if(nrow(rapes) == 0) {
    cat("No rapes this year/this section")
} else{
    map <- hotspotMap(basemap = sectionmap, 
                      mapdf = rapes %>% filter(Lat != -361))
    map
}

```

### 28 day Hotspot map

```{r}
if(nrow(filter(df, Lat != -361 & 
                        CrimeType == "Rape" & 
                        SevenDaysGroup >= curr.week - 3)) == 0) {
    cat("No rapes in the past 28 days in this section")
} else{
    rapes <- filter(df, Lat != -361 & 
                        CrimeType == "Rape" & 
                        SevenDaysGroup >= curr.week - 3)
    map <- hotspotMap(basemap = sectionmap, 
                      mapdf = rapes)
    map
}

```


Reference {data-navmenu="Home"}
======================================================================

Column{data-width=200}
-------------------------------------------------------------------------------

### Action limits explained

The Rochester Police Department is shifting towards the use of "process control" and away from year to year comparison statistics. The goal is to be able to compare current crime counts against a benchline of "normal", rather than the benchline of the previous year (which may have been very high or very low compared to past years).

The Office of Business Intelligence has calculated "action limits" which you can see represented as dashed lines on the projection plots. These limits (both upper and lower) are calculated by using weighted 3 year averages as centering values, and then calculating the standard deviations to find how much variation from that average to expect.

If current counts for a section and crimetype break the upper action limit, it's a signal to investigate the causes of that rise in activity. If current counts break the lower action limit, it's a signal that there may be a beneficial intervention that can be studied and copied in other sections.

Variation within the action limits is assumed to be normal "statistical noise" not requiring attention or resources above the section level.


Column{.tabset .tabset-fade}
------------------------------------------------------------------------------

### Case Status

Treemaps display information as rectangles nested within each other. The data is structured hierarchically, meaning that a hover over a particular crime type will provide the total for that crime for the current year, but a click on a crime type will allow to drill down into the breakdown of the case statuses for that crime. To return to crime types simply click on the heading of the treemap.

The proportion of the values shown to the total are represented by the size of the corresponding rectangle.

Closure and count information for homicides will be inaccurate due to LERMS data issues. Elsewhere in the dashboard, we use MCU data for homicides instead of LERMS data, but that is not possible for the treemap.

![](Z:/Projects/dashboard/RPDCrimeDashboard/Objects/ReferenceTreeMap.png)

### Projection

The projection chart shows the cumulative weekly values experienced to date for the current year. Points in black show values that follow the expected accumulation path. Points in green are lower than expected and points in red are higher than expected. The blue shaded region refers to the expected path to result in a value between the year-end action limits.  

The black faded points on the chart at week 53 show the results of 1000 simulations estimating what our total counts will be at year-end. The large blue point shows the average of those simulations. The black "X" shows the weighted average year-end totals for the past three years. The percentage of the simulations above the upper limit helps to gauge chances of year-end expectations regarding that particular crime if the remainder of the year continues as those have historically.

![](Z:/Projects/dashboard/RPDCrimeDashboard/Objects/ReferenceProjectionPlot.png)

### Aoristic

An aoristic heatmap shows the proportion of activity that occurs in a given hour, on a given day of the week. Lighter shades correspond with less activity, while darker red shades correspond with more activity. We have placed vertical lines that divide between first, second and third platoon hours, and as you can see from the bottom axis, the chart begins at 2300 hrs. The rectangle labeled 'Hr23' corresponds with the amount of activity occuring between 2300 and 2359 hrs on that day of the week.

For crimes that occur over a longer period of time, or for crimes that occurred at an unknown time within a time range, the weight of that crime is divided evenly between the hours that it could have occurred. For instance, the weight for a burglary that occurred at some point between 0800 and 1200 will be spread out evenly between Hr8, Hr9, Hr10 and Hr11.

![](Z:/Projects/dashboard/RPDCrimeDashboard/Objects/ReferenceAoristicPlot.png)


### Maps

Most tabs have two different maps, each in their own tab. The first tab will show a Year-To-Date map, and the second tab will show a map of the last 28 days. Hotspots will also be shown if there are a large enough number of crimes for hotspots to make sense.

The Larcenies page has two additional maps for car break-ins. These maps are also on their own tabs, and display Year-To-Date car break-ins and the last 28 days of car break-ins.

If no map appears, likely there is no data to present (i.e. no events to map).

![](Z:/Projects/dashboard/RPDCrimeDashboard/Objects/ReferenceMapLake.png)


### Tables

The column on the right of each page will show additional data tables, including the breakdown of incidents by beat, by weapon type, larceny type, location type, etc...

